<!--
  ~    Copyright 2017 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->
<h4 mat-dialog-title>{{TagEditorMode[mode]}} Version Tag</h4>
<div mat-dialog-content>
  <app-alert></app-alert>
  <form fxLayout="column" fxLayoutAlign="center center" *ngIf="unsavedVersion" #tagEditorForm="ngForm" name="tagEditorForm">
    <mat-form-field class="w-75">
      <mat-label>
        Version Tag:
      </mat-label>
      <input matInput id="versionTagInput" type="text" name="name" [(ngModel)]="unsavedVersion.name" ng-maxlength="128" required title="Docker Image tag name."
        placeholder="e.g. develop" [disabled]="!(mode=='Add')" />
    </mat-form-field>
    <mat-form-field class="w-75">
      <mat-label>
        Git Reference:
      </mat-label>
      <input matInput id="gitReferenceInput" type="text" name="reference" [(ngModel)]="unsavedVersion.reference" ng-minlength="3"
        ng-maxlength="128" [pattern]="validationPatterns.reference" title="Git branch or tag name." placeholder="e.g. develop" [disabled]="!editMode || (editMode && unsavedVersion.automated) || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" />
      <mat-error *ngIf="formErrors.reference">
        {{formErrors.reference}}
      </mat-error>
    </mat-form-field>
    <mat-form-field class="w-75">
      <mat-label>
        Image ID:
      </mat-label>
      <input matInput type="text" class="form-control" name="image_id" [(ngModel)]="unsavedVersion.image_id" title="Docker Image ID."
        placeholder="e.g. 28d30887157514b6047c9" [disabled]="true" />
    </mat-form-field>
    <mat-form-field class="w-75">
      <mat-label>
        Dockerfile:
      </mat-label>
      <input matInput type="text" class="form-control" #name="ngModel" id="dockerfilePath" name="dockerfilePath" [(ngModel)]="unsavedVersion.dockerfile_path"
        minlength="3" maxlength="256" [pattern]="validationPatterns.dockerfilePath" required title="Relative path to the Dockerfile in the Git repository."
        placeholder="e.g. /Dockerfile" [disabled]="!editMode || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" />
      <mat-error *ngIf="formErrors.dockerfilePath">
        {{formErrors.dockerfilePath}}
      </mat-error>
    </mat-form-field>
    <mat-form-field class="w-75">
      <mat-label>
        CWL Descriptor:
      </mat-label>
      <input matInput type="text" class="form-control" name="cwlPath" [(ngModel)]="unsavedVersion.cwl_path" minlength="3" maxlength="128"
        [pattern]="validationPatterns.cwlPath" [required]="!(unsavedVersion.cwl_path?.length || unsavedVersion.wdl_path?.length)" title="Relative path to the CWL Descriptor in the Git repository."
        placeholder="e.g. /Dockstore.cwl" [disabled]="!editMode || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" />
      <mat-error *ngIf="formErrors.cwlPath">
        {{formErrors.cwlPath}}
      </mat-error>
    </mat-form-field>
    <mat-form-field class="w-75">
      <mat-label>
        WDL Descriptor:
      </mat-label>
      <input matInput type="text" class="form-control" name="wdlPath" [(ngModel)]="unsavedVersion.wdl_path" minlength="3" maxlength="128"
        [pattern]="validationPatterns.wdlPath" [required]="!(unsavedVersion.cwl_path?.length || unsavedVersion.wdl_path?.length)" title="Relative path to the WDL Descriptor in the Git repository."
        placeholder="e.g. /Dockstore.wdl" [disabled]="!editMode || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" />
      <mat-error *ngIf="formErrors.wdlPath">
        {{formErrors.wdlPath}}
      </mat-error>
    </mat-form-field>
    <div class="w-75">
      <label>
        CWL Test Parameter File(s):
      </label>
      <div *ngFor="let item of unsavedCWLTestParameterFilePaths; let i = index;trackBy:trackByIndex;">
        <div class="input-group">
          <input [ngClass]="{ 'input-right-button' : editMode, 'input-no-button' : !editMode }" type="text" class="form-control" name="unsavedCWLTestParameterFilePaths[{{i}}]"
            [(ngModel)]="unsavedCWLTestParameterFilePaths[i]" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath"
            title="Relative path to a CWL Test Parameter File in the Git repository." placeholder="e.g. /test.cwl.json" disabled ng-class="editMode ? 'test_parameter_input' : ''" />
          <span class="input-group-btn">
            <button id="removeCWLTestParameterFileButton" title="Remove CWL test parameter file" type="button" class="btn btn-default form-sm-button"
              *ngIf="editMode && tool?.mode !== DockstoreToolType.ModeEnum.HOSTED" (click)="removeTestParameterFile(i, DescriptorType.CWL)">
              <span class="glyphicon glyphicon-remove"></span>
            </button>
          </span>
        </div>
      </div>
      <div *ngIf="editMode">
        <div class="input-group">
          <input id="addCWLField" [ngClass]="{ 'input-right-button' : editMode }" type="text" #model1="ngModel" class="form-control" name="cwlTestParameterFilePath"
            [(ngModel)]="unsavedTestCWLFile" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath" title="Relative path to a CWL Test Parameter File in the Git repository."
            placeholder="e.g. /test.cwl.json" [disabled]="!editMode || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" ng-class="editMode ? 'test_parameter_input' : ''" />
          <span class="input-group-btn">
            <button title="Add CWL test parameter file" type="button" class="btn btn-default form-sm-button" [disabled]="hasDuplicateTestJson(DescriptorType.CWL) || tool?.mode === DockstoreToolType.ModeEnum.HOSTED"
              (click)="addTestParameterFile(DescriptorType.CWL)" *ngIf="editMode && !(model1.invalid || unsavedTestCWLFile.length == 0)">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
            <button title="Enter a valid path" type="button" class="btn btn-default form-sm-button" [disabled]="model1.invalid || unsavedTestCWLFile.length == 0 || tool?.mode === DockstoreToolType.ModeEnum.HOSTED"
              *ngIf="editMode && (model1.invalid || unsavedTestCWLFile.length == 0)">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
          </span>
        </div>
        <div *ngIf="formErrors.cwlTestParameterFilePath" class="form-error-messages alert alert-danger">
          {{formErrors.cwlTestParameterFilePath}}
        </div>
        <div *ngIf="hasDuplicateTestJson(DescriptorType.CWL)" class="alert alert-danger">
          Duplicate test json files are not allowed.
        </div>
      </div>
      <div *ngIf="unsavedCWLTestParameterFilePaths.length == 0 && !editMode">
        <input class="form-control" placeholder="None provided" [disabled]="true" />
      </div>
    </div>
    <div>
      <label>
        WDL Test Parameter File(s):
      </label>
      <div *ngFor="let item of unsavedWDLTestParameterFilePaths; let i = index;trackBy:trackByIndex;">
        <div class="input-group">
          <input [ngClass]="{ 'input-right-button' : editMode, 'input-no-button' : !editMode }" type="text" class="form-control" name="unsavedWDLTestParameterFilePaths[{{i}}]"
            [(ngModel)]="unsavedWDLTestParameterFilePaths[i]" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath"
            title="Relative path to a WDL Test Parameter File in the Git repository." placeholder="e.g. /test.wdl.json" disabled ng-class="editMode ? 'test_parameter_input' : ''" />
          <span class="input-group-btn">
            <button id="removeWDLTestParameterFileButton" title="Remove WDL test parameter file" type="button" class="btn btn-default form-sm-button"
              *ngIf="editMode && tool?.mode !== DockstoreToolType.ModeEnum.HOSTED" (click)="removeTestParameterFile(i, DescriptorType.WDL)">
              <span class="glyphicon glyphicon-remove"></span>
            </button>
          </span>
        </div>
      </div>
      <div *ngIf="editMode">
        <div class="input-group">
          <input id="addWDLField" [ngClass]="{ 'input-right-button' : editMode }" type="text" #model1="ngModel" class="form-control" name="wdlTestParameterFilePath"
            [(ngModel)]="unsavedTestWDLFile" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath" title="Relative path to a WDL Test Parameter File in the Git repository."
            placeholder="e.g. /test.wdl.json" [disabled]="!editMode || tool?.mode === DockstoreToolType.ModeEnum.HOSTED" ng-class="editMode ? 'test_parameter_input' : ''" />
          <span class="input-group-btn">
            <button title="Add WDL test parameter file" type="button" class="btn btn-default form-sm-button" [disabled]="hasDuplicateTestJson(DescriptorType.WDL) || tool?.mode === DockstoreToolType.ModeEnum.HOSTED"
              (click)="addTestParameterFile(DescriptorType.WDL)" *ngIf="editMode && !(model1.invalid || unsavedTestWDLFile.length == 0)">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
            <button title="Enter a valid path" type="button" class="btn btn-default form-sm-button" [disabled]="model1.invalid || unsavedTestWDLFile.length == 0 || tool?.mode === DockstoreToolType.ModeEnum.HOSTED"
              *ngIf="editMode && (model1.invalid || unsavedTestWDLFile.length == 0)">
              <span class="glyphicon glyphicon-plus"></span>
            </button>
          </span>
        </div>
        <div *ngIf="formErrors.wdlTestParameterFilePath" class="form-error-messages alert alert-danger">
          {{formErrors.wdlTestParameterFilePath}}
        </div>
        <div *ngIf="hasDuplicateTestJson(DescriptorType.WDL)" class="alert alert-danger">
          Duplicate test json files are not allowed.
        </div>
      </div>
      <div *ngIf="unsavedWDLTestParameterFilePaths.length == 0 && !editMode">
        <input class="form-control" placeholder="None provided" [disabled]="true" />
      </div>
    </div>
    <div class="w-75">
      <mat-checkbox name="checkbox" [disabled]="!editMode" [(ngModel)]="unsavedVersion.hidden" matTooltip="Hide tag from public view.">
        Hidden
      </mat-checkbox>
      <div class="w-75">
        <mat-checkbox name="automated" disabled [(ngModel)]="unsavedVersion.automated" matTooltip="Whether tag is automated or not">
          Automated
        </mat-checkbox>
      </div>
    </div>
    <div class="w-75" *ngIf="!unsavedVersion.create">
      <p>Image Size: {{unsavedVersion.size ? getSizeString(unsavedVersion.size) : 'n/a'}}</p>
      <p>Last Modified: {{getDateTimeMessage(unsavedVersion.last_modified)}}</p>
      <mat-checkbox name="valid" disabled [(ngModel)]="unsavedVersion.valid" matTooltip="Whether tag is valid or not">
        Valid
      </mat-checkbox>
      <div>
        <p>Docker Pull: </p>
        <div class="input-group ">
          <input readonly type="text" class="form-control" value="{{ dockerPullCommand }}" aria-describedby="clipboard" #inputTarget>
          <span class="input-group-btn" id="clipboard">
            <button mat-stroked-button class="btn btn-default" type="button" [ngxClipboard]="inputTarget">
              <mat-icon>file_copy</mat-icon>
            </button>
          </span>
        </div>
      </div>
    </div>
    <app-verified-display *ngIf="version?.verified" [sourceFiles]=version?.sourceFiles></app-verified-display>
  </form>
</div>
<div mat-dialog-actions class="pull-right">
  <button type="button" mat-button color="secondary" matDialogClose (click)="onHidden()">Close</button>
  <button id="saveVersionModal" type="button" (click)="onSubmit()" mat-flat-button color="primary" *ngIf="mode==TagEditorMode.Edit"
    [disabled]="!tagEditorForm.form.valid || hasDuplicateTestJson(DescriptorType.WDL) || hasDuplicateTestJson(DescriptorType.CWL)"
    data-dismiss="modal">
    Save Changes
  </button>
</div>
