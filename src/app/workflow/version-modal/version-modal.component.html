<!--
  ~    Copyright 2017 OICR
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->
<h4 mat-dialog-title>{{isPublic || !data.canWrite ? 'View' : 'Edit'}} Version Tag</h4>
<div mat-dialog-content>
  <app-alert></app-alert>
  <form #versionEditorForm="ngForm">
    <div fxLayout="column" fxLayoutAlign="center center">
      <mat-form-field class="w-75 py-1">
        <mat-label>
          Git Reference:
        </mat-label>
        <input matInput type="text" name="reference" [(ngModel)]="version.reference" disabled />
      </mat-form-field>
      <mat-form-field class="w-75 py-1">
        <mat-label>
          Workflow Path:
        </mat-label>
        <input matInput type="text" name="workflow_path" [(ngModel)]="version.workflow_path" minlength="3" maxlength="128" [pattern]="validationPatterns.workflowDescriptorPath"
          required [matTooltip]="tooltip.workflowPath" placeholder="e.g. CancerCollaboratory/dockstore-tool-liftover" [readonly]="isPublic || !canWrite || workflow?.mode === WorkflowType.ModeEnum.HOSTED" />
        <mat-error *ngIf="formErrors.workflow_path"> {{ formErrors.workflow_path }} </mat-error>
      </mat-form-field>
      <div class="w-75 py-1" *ngIf="(descriptorType$ | async) !== ToolDescriptor.TypeEnum.NFL">
        <p>
          Test Parameter File(s):
        </p>
        <div *ngFor="let item of testParameterFilePaths; let i = index;trackBy:trackByIndex;">
          <div class="input-group">
            <input [ngClass]="{ 'input-right-button' : !isPublic, 'input-no-button' : isPublic }" type="text" class="form-control" name="testParameterFilePaths[{{i}}]"
              [(ngModel)]="testParameterFilePaths[i]" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath" title="Relative path to a Test Parameter File in the Git repository."
              placeholder="e.g. /test.json" disabled ng-class="!isPublic ? 'test_parameter_input' : ''" readonly [tooltip]="tooltip.testParameterFile" />
            <span class="input-group-btn">
              <button mat-icon-button title="Remove test parameter file" type="button" class="btn btn-default form-sm-button" *ngIf="!isPublic"
                (click)="removeTestParameterFile(i)">
                <mat-icon>remove</mat-icon>
              </button>
            </span>
          </div>
        </div>
        <div *ngIf="!isPublic">
          <div class="input-group">
            <input [ngClass]="{ 'input-right-button' : !isPublic }" type="text" #model1="ngModel" class="form-control" name="cwlTestParameterFilePath"
              [(ngModel)]="testParameterFilePath" minlength="3" maxlength="128" [pattern]="validationPatterns.testFilePath" placeholder="e.g. /test.cwl.json"
              [disabled]="isPublic || !canWrite || workflow?.mode === WorkflowType.ModeEnum.HOSTED" ng-class="!isPublic ? 'test_parameter_input' : ''" />
            <span class="input-group-btn">
              <button mat-icon-button title="Add test parameter file" type="button" class="btn btn-default form-sm-button" [disabled]="hasDuplicateTestJson() || workflow?.mode === WorkflowType.ModeEnum.HOSTED || !canWrite"
                (click)="addTestParameterFile()" *ngIf="!isPublic && !(model1.invalid || testParameterFilePath.length == 0)">
                <mat-icon>add</mat-icon>
              </button>
              <button mat-icon-button title="Enter a valid path" type="button" class="btn btn-default form-sm-button" [disabled]="model1.invalid || testParameterFilePath.length == 0 || workflow?.mode === WorkflowType.ModeEnum.HOSTED || !canWrite"
                *ngIf="!isPublic && (model1.invalid || testParameterFilePath.length == 0)">
                <mat-icon>add</mat-icon>
              </button>
            </span>
          </div>
          <mat-error *ngIf="formErrors.cwlTestParameterFilePath">
            {{formErrors.cwlTestParameterFilePath}}
          </mat-error>
          <mat-error *ngIf="hasDuplicateTestJson()">
            Duplicate test json files are not allowed.
          </mat-error>
        </div>
        <div *ngIf="testParameterFilePaths.length == 0 && isPublic">
          <input class="form-control" placeholder="None provided" [disabled]="true" />
        </div>
      </div>
      <div class="w-75 py-1" >
      <mat-checkbox name="checkbox" [disabled]="isPublic || !canWrite" [(ngModel)]="version.hidden" matTooltip="Hide tag from public view.">
        Hidden
      </mat-checkbox>
    </div>
      <p class="w-75 py-1">
        Last Modified: {{getDateTimeMessage(version.last_modified)}}
      </p>
      <p class="w-75 py-1">Valid: {{version.valid ? 'Yes' : 'No'}}</p>
      <app-verified-display *ngIf="version?.verified" [sourceFiles]=version?.sourceFiles></app-verified-display>
    </div>
  </form>
</div>
<div mat-dialog-actions class="pull-right">
  <button type="button" mat-button color="secondary" mat-dialog-close>Close</button>
  <button type="button" (click)="saveChanges()" mat-flat-button color="primary" *ngIf="!isPublic && canWrite" [disabled]="!versionEditorForm.form.valid"
    data-dismiss="modal">
    Save Changes
  </button>
</div>
